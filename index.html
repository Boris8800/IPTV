<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Complete IPTV Platform (Enhanced)</title>

  <!-- FontAwesome y hls.js siguen desde CDN como en tu original -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    /* --- Mantengo exactamente los estilos visuales que tenías --- */
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --secondary: #2c3e50;
      --accent: #e74c3c;
      --light: #ecf0f1;
      --dark: #1a1a2e;
      --gray: #95a5a6;
      --success: #2ecc71;
      --warning: #f39c12;
      --danger: #e74c3c;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: var(--dark); color: var(--light); line-height: 1.6; overflow-x: hidden; }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }

    header { background-color: var(--secondary); padding: 15px 0; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
    .header-content { display:flex; justify-content:space-between; align-items:center; }
    .logo { display:flex; align-items:center; gap:10px; }
    .logo i { color: var(--primary); font-size:28px; }
    .logo h1 { font-size:24px; font-weight:700; background: linear-gradient(to right, var(--primary), var(--accent)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .nav-links { display:flex; list-style:none; gap:25px; }
    .nav-links a { color:var(--light); text-decoration:none; font-weight:500; transition:var(--transition); display:flex; align-items:center; gap:5px; }
    .nav-links a:hover { color:var(--primary); }
    .nav-links a.active { color:var(--primary); }
    .user-actions { display:flex; align-items:center; gap:15px; }

    .btn { padding:8px 16px; border-radius:4px; font-weight:600; cursor:pointer; transition:var(--transition); border:none; display:flex; align-items:center; gap:8px; }
    .btn-primary { background-color:var(--primary); color:white; }
    .btn-primary:hover { background-color:var(--primary-dark); }
    .btn-outline { background-color:transparent; border:1px solid var(--primary); color:var(--primary); }
    .btn-outline:hover { background-color:var(--primary); color:white; }

    .search-bar { display:flex; align-items:center; background: rgba(255,255,255,0.1); border-radius:4px; padding:8px 15px; width:300px; }
    .search-bar input { background:transparent; border:none; color:var(--light); width:100%; padding:5px; outline:none; }
    .search-bar i { color:var(--gray); }

    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center; overflow-y:auto; padding:20px; }
    .url-modal-content { background:var(--secondary); padding:30px; border-radius:8px; width:90%; max-width:600px; max-height:85vh; overflow-y:auto; box-shadow:var(--shadow); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); }
    .modal-header h3 { display:flex; align-items:center; gap:10px; font-size:22px; }
    .close-modal { background:none; border:none; color:var(--light); font-size:28px; cursor:pointer; transition:var(--transition); }
    .close-modal:hover { color:var(--accent); }

    .url-input-group { margin-bottom:20px; }
    .url-input-group label { display:block; margin-bottom:8px; font-weight:500; font-size:16px; }
    .url-input-group input { width:100%; padding:12px 15px; border-radius:4px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color:var(--light); font-size:16px; transition:var(--transition); }
    .url-input-group input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 2px rgba(52,152,219,0.2); }

    .proxy-options { margin-bottom:20px; }
    .proxy-options h4 { margin-bottom:15px; font-size:18px; color:var(--primary); display:flex; align-items:center; gap:8px; }
    .proxy-options label { display:flex; align-items:center; gap:10px; margin-bottom:10px; cursor:pointer; padding:10px 12px; border-radius:4px; transition:var(--transition); border:1px solid transparent; }
    .proxy-options label:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
    .proxy-options input[type="radio"] { margin:0; transform:scale(1.2); }

    .custom-proxy-section { margin-top:20px; padding:15px; background: rgba(255,255,255,0.05); border-radius:8px; border:1px solid rgba(255,255,255,0.1); }
    .custom-proxy-section h4 { margin-bottom:10px; color:var(--primary); display:flex; align-items:center; gap:8px; }
    .custom-proxy-input { display:flex; gap:10px; margin-bottom:10px; }
    .custom-proxy-input input { flex:1; padding:10px 12px; border-radius:4px; border:1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color:var(--light); transition:var(--transition); }
    .custom-proxy-input input:focus { outline:none; border-color:var(--primary); }
    .custom-proxy-input button { padding:10px 15px; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer; transition:var(--transition); font-weight:600; }
    .custom-proxy-input button:hover { background:var(--primary-dark); }

    .url-help { background: rgba(255,255,255,0.05); padding:15px; border-radius:4px; margin-bottom:20px; font-size:14px; border:1px solid rgba(255,255,255,0.1); }
    .url-help h4 { margin-bottom:8px; color:var(--primary); }
    .url-help ul { list-style:none; padding-left:0; }
    .url-help li { margin-bottom:5px; display:flex; align-items:center; gap:8px; }
    .url-help li i { color:var(--success); font-size:12px; }

    .url-actions { display:flex; gap:15px; justify-content:center; margin-top:20px; flex-wrap:wrap; }
    .url-actions .btn { padding:10px 20px; font-size:16px; min-width:160px; justify-content:center; }

    .status-message { padding:12px 15px; border-radius:4px; margin:15px 0; display:flex; align-items:center; gap:10px; font-size:14px; }
    .status-success { background: rgba(46,204,113,0.2); border-left:4px solid var(--success); color:#d1f7e5; }
    .status-error { background: rgba(231,76,60,0.2); border-left:4px solid var(--danger); color:#fadbd8; }
    .status-warning { background: rgba(243,156,18,0.2); border-left:4px solid var(--warning); color:#fdebd0; }

    .main-content { display:grid; grid-template-columns:400px 1fr; gap:20px; padding:20px 0; min-height:calc(100vh - 140px); }
    .channels-sidebar { background-color: rgba(0,0,0,0.3); border-radius:8px; padding:20px; overflow-y:auto; height:calc(100vh - 160px); display:flex; flex-direction:column; }
    .sidebar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1); flex-shrink:0; }
    .sidebar-header h3 { font-size:18px; display:flex; align-items:center; gap:8px; }
    .category-tabs { display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; flex-shrink:0; flex-wrap:wrap; }
    .category-tab { padding:8px 15px; border-radius:20px; font-size:13px; cursor:pointer; transition:var(--transition); background: rgba(255,255,255,0.05); }
    .category-tab.active { background: var(--primary); }

    .groups-list { display:flex; flex-direction:column; gap:10px; overflow-y:auto; flex:1; }
    .group-item { background: rgba(255,255,255,0.05); border-radius:6px; padding:12px; cursor:pointer; transition:var(--transition); }
    .group-item:hover { background: rgba(255,255,255,0.1); }
    .group-item.active { background: var(--primary); }
    .group-header { display:flex; justify-content:space-between; align-items:center; }
    .group-name { font-weight:600; font-size:14px; }
    .group-count { background: rgba(255,255,255,0.2); padding:2px 8px; border-radius:12px; font-size:12px; }
    .channels-list { margin-top:10px; display:none; max-height:280px; overflow-y:auto; }
    .group-item.active .channels-list { display:block; }

    .channel-item { display:flex; align-items:center; gap:10px; padding:8px; border-radius:4px; margin-bottom:5px; cursor:pointer; transition:var(--transition); }
    .channel-item:hover { background: rgba(255,255,255,0.1); }
    .channel-item.active { background: rgba(255,255,255,0.15); } /* Cambiado a tono más oscuro */
    .channel-logo { width:30px; height:30px; border-radius:4px; object-fit:cover; }
    .channel-info { flex:1; min-width:0; }
    .channel-name { font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .channel-resolution { font-size:11px; color:var(--gray); }
    .favorite-btn { background:none; border:none; color:var(--gray); cursor:pointer; font-size:14px; transition:var(--transition); padding:4px; }
    .favorite-btn.active { color:var(--accent); }

    .player-section { background-color: rgba(0,0,0,0.3); border-radius:8px; padding:20px; display:flex; flex-direction:column; height:calc(100vh - 160px); }
    .player-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .player-header h3 { font-size:20px; display:flex; align-items:center; gap:10px; }
    .now-playing { font-size:14px; color:var(--gray); }
    .video-container { position:relative; width:100%; flex:1; background-color:#000; border-radius:8px; overflow:hidden; margin-bottom:20px; }
    #videoPlayer { width:100%; height:100%; background-color:#000; }
    .player-controls { display:flex; justify-content:space-between; align-items:center; flex-shrink:0; }
    .control-group { display:flex; gap:10px; }
    .control-btn { background: rgba(255,255,255,0.1); border:none; color:white; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:var(--transition); }
    .control-btn:hover { background: rgba(255,255,255,0.2); }
    .quality-selector { background: rgba(255,255,255,0.1); border:none; color:white; padding:8px 15px; border-radius:4px; }

    .playlists-section { background-color: rgba(0,0,0,0.3); border-radius:8px; padding:20px; margin-top:20px; }
    .section-title { text-align:center; margin-bottom:30px; }
    .section-title h2 { font-size:28px; margin-bottom:10px; color:var(--light); display:flex; align-items:center; justify-content:center; gap:10px; }
    .section-title p { color:var(--gray); max-width:600px; margin:0 auto; }

    .playlists-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:20px; margin-bottom:30px; }
    .playlist-card { background: rgba(255,255,255,0.05); border-radius:8px; padding:20px; transition:var(--transition); cursor:pointer; }
    .playlist-card:hover { transform: translateY(-5px); box-shadow:var(--shadow); }
    .playlist-card.active { border:2px solid var(--primary); }
    .playlist-icon { font-size:40px; color:var(--primary); margin-bottom:15px; text-align:center; }
    .playlist-info h4 { margin-bottom:10px; font-size:18px; }
    .playlist-info p { color:var(--gray); font-size:14px; margin-bottom:5px; }
    .playlist-actions { display:flex; gap:10px; margin-top:15px; }
    .playlist-actions .btn { flex:1; justify-content:center; padding:6px 12px; font-size:12px; }

    .upload-section { background-color: rgba(0,0,0,0.3); border-radius:8px; padding:30px; margin-top:20px; }
    .upload-area { border:2px dashed var(--primary); border-radius:8px; padding:40px; text-align:center; margin-bottom:20px; transition:var(--transition); cursor:pointer; }
    .upload-area:hover { background-color: rgba(52,152,219,0.1); }
    .upload-area i { font-size:50px; color:var(--primary); margin-bottom:15px; }
    .upload-area h3 { margin-bottom:10px; }
    .upload-area p { color:var(--gray); margin-bottom:15px; }
    .formats-list { display:flex; justify-content:center; gap:15px; margin-top:20px; flex-wrap:wrap; }
    .format-tag { background: rgba(255,255,255,0.1); padding:5px 15px; border-radius:20px; font-size:14px; }

    .playlist-actions-main { display:flex; gap:15px; justify-content:center; }

    .spinner { border:4px solid rgba(255,255,255,0.3); border-radius:50%; border-top:4px solid var(--primary); width:40px; height:40px; animation:spin 1s linear infinite; margin:20px auto; }
    @keyframes spin { 0%{ transform:rotate(0deg); } 100%{ transform:rotate(360deg); } }
    .hidden { display:none; }

    .empty-state { text-align:center; padding:40px; color:var(--gray); }
    .empty-state i { font-size:60px; margin-bottom:20px; color:var(--primary); }

    /* Estilos mejorados para el scroll de canales */
    .channels-list::-webkit-scrollbar {
      width: 8px;
    }
    .channels-list::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }
    .channels-list::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }
    .channels-list::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* Para Firefox */
    .channels-list {
      scrollbar-width: thin;
      scrollbar-color: var(--primary) rgba(255, 255, 255, 0.05);
    }

    @media (max-width:1024px) { .main-content { grid-template-columns:1fr; } .channels-sidebar { height:auto; max-height:400px; } .player-section { height:auto; } }
    @media (max-width:768px) {
      .nav-links { display:none; }
      .search-bar { width:200px; }
      .playlist-actions-main { flex-direction:column; align-items:center; }
      .playlists-grid { grid-template-columns:1fr; }
      .proxy-options label { font-size:14px; }
      .category-tabs { flex-direction:column; }
      .custom-proxy-input { flex-direction:column; }
      .url-actions { flex-direction:column; }
      .url-actions .btn { width:100%; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header role="banner">
    <div class="container">
      <div class="header-content" role="navigation" aria-label="Main navigation">
        <div class="logo" aria-hidden="true">
          <i class="fas fa-tv"></i>
          <h1>IPTV Web Platform</h1>
        </div>
        <ul class="nav-links" role="menubar">
          <li role="none"><a href="#" class="active" role="menuitem"><i class="fas fa-home" aria-hidden="true"></i> Home</a></li>
          <li role="none"><a href="#player" role="menuitem"><i class="fas fa-play-circle" aria-hidden="true"></i> Player</a></li>
          <li role="none"><a href="#playlists" role="menuitem"><i class="fas fa-list" aria-hidden="true"></i> Playlists</a></li>
          <li role="none"><a href="#upload" role="menuitem"><i class="fas fa-upload" aria-hidden="true"></i> Upload</a></li>
          <li role="none"><a href="xtream.html" role="menuitem"><i class="fas fa-satellite-dish" aria-hidden="true"></i>Xtream</a></li>
        </ul>
        
        <div class="user-actions" role="region" aria-label="User actions">
          <div class="search-bar" role="search" aria-label="Buscar canales">
            <i class="fas fa-search" aria-hidden="true"></i>
            <input type="text" id="searchInput" placeholder="Search channels..." aria-label="Search channels">
          </div>
          
          <button class="btn btn-outline" id="uploadBtn" aria-haspopup="dialog"><i class="fas fa-plus" aria-hidden="true"></i> Add Playlist</button>
          <button class="btn btn-outline" id="addUrlBtn" aria-haspopup="dialog"><i class="fas fa-link" aria-hidden="true"></i> Add URL</button>
         
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container" role="main">
    <div class="main-content">
      <!-- Channels Sidebar -->
      <aside class="channels-sidebar" aria-label="Channels sidebar">
        <div class="sidebar-header">
          <h3><i class="fas fa-list" aria-hidden="true"></i> Channels</h3>
          <span id="channelsCount" aria-live="polite">0 channels</span>
        </div>

        <div class="category-tabs" role="tablist" aria-label="Categories">
          <div class="category-tab active" data-category="all" role="tab" tabindex="0">All</div>
          <div class="category-tab" data-category="favorites" role="tab" tabindex="0">Favorites</div>
          <div class="category-tab" data-category="tv" role="tab" tabindex="0">TV</div>
          <div class="category-tab" data-category="movies" role="tab" tabindex="0">Movies</div>
          <div class="category-tab" data-category="series" role="tab" tabindex="0">Series</div>
        </div>

        <div class="groups-list" id="groupsList" aria-live="polite"></div>
      </aside>

      <!-- Player Section -->
      <section class="player-section" id="player" aria-label="Player section">
        <div class="player-header">
          <h3><i class="fas fa-play-circle" aria-hidden="true"></i> Player</h3>
          <div class="now-playing" id="nowPlaying">Select a channel to start</div>
        </div>

        <div class="video-container" role="region" aria-label="Video player">
          <video id="videoPlayer" controls aria-label="Video player">Your browser does not support the video element.</video>
        </div>

        <div class="player-controls" role="toolbar" aria-label="Player controls">
          <div class="control-group">
            <button class="control-btn" id="playBtn" aria-label="Play"><i class="fas fa-play" aria-hidden="true"></i></button>
            <button class="control-btn" id="pauseBtn" aria-label="Pause"><i class="fas fa-pause" aria-hidden="true"></i></button>
            <button class="control-btn" id="fullscreenBtn" aria-label="Fullscreen"><i class="fas fa-expand" aria-hidden="true"></i></button>
          </div>
          <div class="control-group">
            <button class="control-btn" id="subtitlesBtn" aria-label="Subtitles"><i class="fas fa-closed-captioning" aria-hidden="true"></i></button>
            <button class="control-btn" id="settingsBtn" aria-label="Settings"><i class="fas fa-cog" aria-hidden="true"></i></button>
            <select class="quality-selector" id="qualitySelector" aria-label="Quality selector">
              <option value="auto">Auto</option>
              <!-- quality options se poblarán dinámicamente -->
            </select>
          </div>
        </div>
      </section>
    </div>

    <!-- Playlists Section -->
    <section class="playlists-section" id="playlists" aria-label="Playlists">
      <div class="section-title">
        <h2><i class="fas fa-list" aria-hidden="true"></i> Your Playlists</h2>
        <p>Manage and organize your IPTV playlists</p>
      </div>

      <div class="playlists-grid" id="playlistsGrid" aria-live="polite">
        <div class="empty-state" id="emptyPlaylists">
          <i class="fas fa-list" aria-hidden="true"></i>
          <h3>No playlists available</h3>
          <p>Upload your first M3U playlist to get started</p>
        </div>
      </div>
    </section>

    <!-- Upload Section -->
    <section class="upload-section" id="upload" aria-label="Upload playlist">
      <div class="section-title">
        <h2><i class="fas fa-upload" aria-hidden="true"></i> Upload Playlist</h2>
        <p>Import your M3U playlist to start watching your channels organized by categories</p>
      </div>

      <div class="upload-area" id="uploadArea" role="button" tabindex="0" aria-label="Drag and drop M3U file or click to select">
        <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
        <h3>Drag your M3U file here</h3>
        <p>or click to select a file (no size limit)</p>
        <input type="file" id="fileInput" accept=".m3u,.m3u8,.xspf,.json" style="display:none">
        <div class="formats-list">
          <div class="format-tag">M3U</div>
          <div class="format-tag">M3U8</div>
          <div class="format-tag">XSPF</div>
          <div class="format-tag">JSON</div>
        </div>
      </div>

      <div class="playlist-actions-main">
        <button class="btn btn-primary" id="addPlaylistBtn"><i class="fas fa-plus" aria-hidden="true"></i> New Playlist</button>
        <button class="btn btn-outline" id="addUrlModalBtn"><i class="fas fa-link" aria-hidden="true"></i> Add from URL</button>
      </div>
    </section>
  </div>

  <!-- URL Input Modal -->
  <div class="modal" id="urlModal" role="dialog" aria-modal="true" aria-labelledby="urlModalTitle" aria-hidden="true">
    <div class="url-modal-content">
      <div class="modal-header">
        <h3 id="urlModalTitle"><i class="fas fa-link" aria-hidden="true"></i> Add Playlist from URL</h3>
        <button class="close-modal" id="closeUrlModal" aria-label="Close">&times;</button>
      </div>

      <div class="url-input-group">
        <label for="playlistUrl">Playlist URL:</label>
        <input type="url" id="playlistUrl" placeholder="https://example.com/playlist.m3u" required aria-required="true">
      </div>

      <div class="proxy-options" role="radiogroup" aria-label="Proxy options">
        <h4><i class="fas fa-server" aria-hidden="true"></i> Select CORS Proxy:</h4>
        <label><input type="radio" name="proxyOption" value="direct" checked> Try Direct Connection (may fail due to CORS)</label>
        <label><input type="radio" name="proxyOption" value="corsproxy"> CORS Proxy (corsproxy.io)</label>
        <label><input type="radio" name="proxyOption" value="allorigins"> AllOrigins Proxy (api.allorigins.win)</label>
        <label><input type="radio" name="proxyOption" value="corsanywhere"> CORS Anywhere (cors-anywhere.herokuapp.com)</label>
        <label><input type="radio" name="proxyOption" value="thingproxy"> ThingProxy (thingproxy.freeboard.io)</label>
        <label><input type="radio" name="proxyOption" value="corscontainer"> CORS Container (api.codetabs.com)</label>
        <label><input type="radio" name="proxyOption" value="crossorigin"> CrossOrigin (crossorigin.me)</label>
        <label><input type="radio" name="proxyOption" value="corsbridge"> CORS Bridge (corsbridge.com)</label>
        <label><input type="radio" name="proxyOption" value="custom"> Custom Proxy (configure below)</label>
      </div>

      <div class="custom-proxy-section" id="customProxySection" style="display:none;">
        <h4><i class="fas fa-cog" aria-hidden="true"></i> Custom Proxy Configuration</h4>
        <p>Enter the URL of your custom proxy (e.g., proxy.php)</p>
        <div class="custom-proxy-input">
          <input type="text" id="customProxyUrl" placeholder="https://yourdomain.com/proxy.php?url=">
          <button id="saveCustomProxy">Save</button>
        </div>
        <div class="url-help">
          <p><strong>Tip:</strong> Your proxy should accept a URL parameter and return the M3U content. Example: <code>proxy.php?url=ENCODED_URL</code></p>
        </div>
      </div>

      <div class="url-help">
        <h4><i class="fas fa-lightbulb" aria-hidden="true"></i> Tips for URL Playlists:</h4>
        <ul>
          <li><i class="fas fa-check" aria-hidden="true"></i> Use direct M3U URLs ending with .m3u or .m3u8</li>
          <li><i class="fas fa-check" aria-hidden="true"></i> CORS Proxy bypasses browser security restrictions</li>
          <li><i class="fas fa-check" aria-hidden="true"></i> Try different proxy options if one fails</li>
          <li><i class="fas fa-check" aria-hidden="true"></i> Make sure the URL is accessible from your network</li>
        </ul>
      </div>

      <div id="urlStatus" aria-live="polite"></div>

      <div class="url-actions">
        <button class="btn btn-primary" id="loadUrlBtn"><i class="fas fa-download" aria-hidden="true"></i> Load Playlist</button>
        <button class="btn btn-outline" id="testUrlBtn"><i class="fas fa-vial" aria-hidden="true"></i> Test URL</button>
      </div>
    </div>
  </div>

  <!-- Mensaje informativo abajo (no visible por defecto) -->
  <div id="globalStatus" style="position:fixed; bottom:16px; left:16px; z-index:1100;"></div>

  <script>
/* =====================================================================
   STREAMTV: Enhanced Single-File HTML
   - Replaces localStorage with IndexedDB (robust for big playlists)
   - Improved hls.js integration with real quality switching
   - Paginated group rendering ("Load more") to avoid huge DOM
   - Accessibility improvements (aria, keyboard)
   - Comments include example proxy implementations (PHP & Node)
   ===================================================================== */

(function(){
  'use strict';

  /* ---------------------------
     IndexedDB helper (simple promisified wrapper)
     Stores:
       - playlists (object store)
       - favs (single record)
       - settings (customProxy)
     Key design:
       - playlists store: keyPath = id (timestamp)
  ----------------------------*/
  const IDB_DB = 'streamtv-db-v1';
  const IDB_VERSION = 1;
  const IDB_STORES = ['playlists','settings','favorites'];

  function openDb() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(IDB_DB, IDB_VERSION);
      req.onupgradeneeded = function(e) {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('playlists')) {
          db.createObjectStore('playlists', { keyPath: 'id' });
        }
        if (!db.objectStoreNames.contains('favorites')) {
          db.createObjectStore('favorites', { keyPath: 'key' });
        }
        if (!db.objectStoreNames.contains('settings')) {
          db.createObjectStore('settings', { keyPath: 'key' });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function idbPut(storeName, value) {
    const db = await openDb();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      const store = tx.objectStore(storeName);
      const req = store.put(value);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function idbGet(storeName, key) {
    const db = await openDb();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.get(key);
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function idbGetAll(storeName) {
    const db = await openDb();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readonly');
      const store = tx.objectStore(storeName);
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function idbDelete(storeName, key) {
    const db = await openDb();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(storeName, 'readwrite');
      const store = tx.objectStore(storeName);
      const req = store.delete(key);
      req.onsuccess = () => resolve();
      req.onerror = () => reject(req.error);
    });
  }

  /* ---------------------------
     App State
  ----------------------------*/
  let playlists = []; // loaded from IDB
  let favorites = []; // array of channelIds
  let currentPlaylistId = null;
  let currentPlaylist = [];
  let currentCategory = 'all';
  let hls = null;
  let customProxyUrl = null;
  const CHANNEL_RENDER_BATCH = 60; // cantidad por "paginación" en cada grupo

  /* ---------------------------
     DOM references
  ----------------------------*/
  const videoPlayer = document.getElementById('videoPlayer');
  const playBtn = document.getElementById('playBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const qualitySelector = document.getElementById('qualitySelector');
  const nowPlaying = document.getElementById('nowPlaying');
  const groupsList = document.getElementById('groupsList');
  const channelsCount = document.getElementById('channelsCount');
  const searchInput = document.getElementById('searchInput');
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const urlModal = document.getElementById('urlModal');
  const closeUrlModal = document.getElementById('closeUrlModal');
  const addUrlBtn = document.getElementById('addUrlBtn');
  const addUrlModalBtn = document.getElementById('addUrlModalBtn');
  const loadUrlBtn = document.getElementById('loadUrlBtn');
  const testUrlBtn = document.getElementById('testUrlBtn');
  const playlistUrl = document.getElementById('playlistUrl');
  const proxyOptions = document.querySelectorAll('input[name="proxyOption"]');
  const customProxySection = document.getElementById('customProxySection');
  const customProxyUrlInput = document.getElementById('customProxyUrl');
  const saveCustomProxy = document.getElementById('saveCustomProxy');
  const urlStatus = document.getElementById('urlStatus');
  const categoryTabs = document.querySelectorAll('.category-tab');
  const playlistsGrid = document.getElementById('playlistsGrid');
  const emptyPlaylists = document.getElementById('emptyPlaylists');
  const addPlaylistBtn = document.getElementById('addPlaylistBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const globalStatus = document.getElementById('globalStatus');

  /* ---------------------------
     Initialize App
  ----------------------------*/
  async function init() {
    // Load saved data
    await loadPlaylists();
    await loadFavorites();
    await loadSettings();
    renderPlaylists();
    setupEventListeners();
    showStatus('App initialized', 'success');
  }

  async function loadPlaylists() {
    try {
      const stored = await idbGetAll('playlists');
      playlists = stored || [];
    } catch (e) {
      console.error('Error loading playlists:', e);
      playlists = [];
    }
  }

  async function loadFavorites() {
    try {
      const favs = await idbGet('favorites', 'favorites');
      favorites = favs ? favs.value : [];
    } catch (e) {
      console.error('Error loading favorites:', e);
      favorites = [];
    }
  }

  async function loadSettings() {
    try {
      const settings = await idbGet('settings', 'customProxy');
      customProxyUrl = settings ? settings.value : null;
      if (customProxyUrl) {
        customProxyUrlInput.value = customProxyUrl;
      }
    } catch (e) {
      console.error('Error loading settings:', e);
    }
  }

  async function saveFavorites() {
    try {
      await idbPut('favorites', { key: 'favorites', value: favorites });
    } catch (e) {
      console.error('Error saving favorites:', e);
    }
  }

  function setupEventListeners() {
    // Player controls
    playBtn.addEventListener('click', () => videoPlayer.play());
    pauseBtn.addEventListener('click', () => videoPlayer.pause());
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    qualitySelector.addEventListener('change', changeQuality);

    // Search
    searchInput.addEventListener('input', debounce(handleSearch, 300));

    // Upload
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--primary)';
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.borderColor = 'var(--primary)';
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--primary)';
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileUpload(files[0]);
      }
    });
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileUpload(e.target.files[0]);
      }
    });

    // URL Modal
    addUrlBtn.addEventListener('click', openUrlModal);
    addUrlModalBtn.addEventListener('click', openUrlModal);
    closeUrlModal.addEventListener('click', closeUrlModalHandler);
    loadUrlBtn.addEventListener('click', loadUrlPlaylist);
    testUrlBtn.addEventListener('click', testUrl);
    proxyOptions.forEach(option => {
      option.addEventListener('change', handleProxyOptionChange);
    });
    saveCustomProxy.addEventListener('click', saveCustomProxyHandler);

    // Categories
    categoryTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        categoryTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentCategory = tab.dataset.category;
        renderGroups();
      });
    });

    // Playlist actions
    addPlaylistBtn.addEventListener('click', () => fileInput.click());
    uploadBtn.addEventListener('click', () => fileInput.click());

    // Global click to close modals
    window.addEventListener('click', (e) => {
      if (e.target === urlModal) {
        closeUrlModalHandler();
      }
    });
  }

  /* ---------------------------
     Playlist Management
  ----------------------------*/
  function renderPlaylists() {
    if (playlists.length === 0) {
      emptyPlaylists.style.display = 'block';
      playlistsGrid.innerHTML = '';
      playlistsGrid.appendChild(emptyPlaylists);
      return;
    }

    emptyPlaylists.style.display = 'none';
    playlistsGrid.innerHTML = '';

    playlists.forEach(playlist => {
      const card = document.createElement('div');
      card.className = 'playlist-card';
      if (playlist.id === currentPlaylistId) {
        card.classList.add('active');
      }

      const channelCount = playlist.channels ? playlist.channels.length : 0;
      const groupCount = playlist.groups ? playlist.groups.length : 0;

      card.innerHTML = `
        <div class="playlist-icon">
          <i class="fas fa-list" aria-hidden="true"></i>
        </div>
        <div class="playlist-info">
          <h4>${playlist.name}</h4>
          <p><i class="fas fa-tv" aria-hidden="true"></i> ${channelCount} channels</p>
          <p><i class="fas fa-folder" aria-hidden="true"></i> ${groupCount} categories</p>
          <p><i class="fas fa-calendar" aria-hidden="true"></i> ${new Date(playlist.id).toLocaleDateString()}</p>
        </div>
        <div class="playlist-actions">
          <button class="btn btn-primary load-playlist" data-id="${playlist.id}"><i class="fas fa-play" aria-hidden="true"></i> Load</button>
          <button class="btn btn-outline delete-playlist" data-id="${playlist.id}"><i class="fas fa-trash" aria-hidden="true"></i> Delete</button>
        </div>
      `;

      playlistsGrid.appendChild(card);
    });

    // Add event listeners to playlist buttons
    document.querySelectorAll('.load-playlist').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.closest('.load-playlist').dataset.id;
        loadPlaylist(id);
      });
    });

    document.querySelectorAll('.delete-playlist').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.closest('.delete-playlist').dataset.id;
        deletePlaylist(id);
      });
    });
  }

  async function loadPlaylist(id) {
    const playlist = playlists.find(p => p.id == id);
    if (!playlist) return;

    currentPlaylistId = id;
    currentPlaylist = playlist.channels || [];
    renderPlaylists();
    renderGroups();
    showStatus(`Loaded playlist: ${playlist.name}`, 'success');
  }

  async function deletePlaylist(id) {
    if (!confirm('Are you sure you want to delete this playlist?')) return;

    try {
      await idbDelete('playlists', parseInt(id));
      playlists = playlists.filter(p => p.id != id);
      
      if (currentPlaylistId == id) {
        currentPlaylistId = null;
        currentPlaylist = [];
        groupsList.innerHTML = '';
        channelsCount.textContent = '0 channels';
        nowPlaying.textContent = 'Select a channel to start';
      }
      
      renderPlaylists();
      showStatus('Playlist deleted', 'success');
    } catch (e) {
      console.error('Error deleting playlist:', e);
      showStatus('Error deleting playlist', 'error');
    }
  }

  /* ---------------------------
     File Upload & Parsing
  ----------------------------*/
  function handleFileUpload(file) {
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const content = e.target.result;
      parsePlaylist(content, file.name);
    };
    reader.readAsText(file);
  }

  function parsePlaylist(content, filename) {
    showStatus('Parsing playlist...', 'warning');
    
    // Simple M3U parser
    const lines = content.split('\n');
    const channels = [];
    const groups = new Set();
    let currentChannel = null;

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();
      
      if (line.startsWith('#EXTINF:')) {
        // Parse EXTINF line
        const match = line.match(/#EXTINF:(-?\d+)(?:\s+(.*))?,(.*)/);
        if (match) {
          currentChannel = {
            id: channels.length,
            name: match[3] || 'Unknown',
            url: '',
            group: 'General',
            tvg: {
              id: '',
              name: '',
              logo: ''
            }
          };

          // Parse attributes
          const attrs = match[2] || '';
          const logoMatch = attrs.match(/tvg-logo="([^"]*)"/);
          if (logoMatch) currentChannel.tvg.logo = logoMatch[1];

          const groupMatch = attrs.match(/group-title="([^"]*)"/);
          if (groupMatch) currentChannel.group = groupMatch[1];

          const idMatch = attrs.match(/tvg-id="([^"]*)"/);
          if (idMatch) currentChannel.tvg.id = idMatch[1];

          groups.add(currentChannel.group);
        }
      } else if (line && !line.startsWith('#') && currentChannel) {
        // This is the URL line
        currentChannel.url = line;
        channels.push(currentChannel);
        currentChannel = null;
      }
    }

    if (channels.length === 0) {
      showStatus('No channels found in the playlist', 'error');
      return;
    }

    // Create playlist object
    const playlist = {
      id: Date.now(),
      name: filename.replace(/\.[^/.]+$/, ""), // Remove extension
      channels: channels,
      groups: Array.from(groups)
    };

    // Save and load the playlist
    savePlaylist(playlist);
  }

  async function savePlaylist(playlist) {
    try {
      await idbPut('playlists', playlist);
      playlists.push(playlist);
      renderPlaylists();
      loadPlaylist(playlist.id);
      showStatus(`Playlist "${playlist.name}" loaded with ${playlist.channels.length} channels`, 'success');
    } catch (e) {
      console.error('Error saving playlist:', e);
      showStatus('Error saving playlist', 'error');
    }
  }

  /* ---------------------------
     URL Playlist Loading
  ----------------------------*/
  function openUrlModal() {
    urlModal.style.display = 'flex';
    playlistUrl.focus();
  }

  function closeUrlModalHandler() {
    urlModal.style.display = 'none';
    urlStatus.innerHTML = '';
  }

  function handleProxyOptionChange(e) {
    if (e.target.value === 'custom') {
      customProxySection.style.display = 'block';
    } else {
      customProxySection.style.display = 'none';
    }
  }

  async function saveCustomProxyHandler() {
    const url = customProxyUrlInput.value.trim();
    if (!url) {
      showUrlStatus('Please enter a custom proxy URL', 'error');
      return;
    }

    try {
      await idbPut('settings', { key: 'customProxy', value: url });
      customProxyUrl = url;
      showUrlStatus('Custom proxy saved successfully', 'success');
    } catch (e) {
      console.error('Error saving custom proxy:', e);
      showUrlStatus('Error saving custom proxy', 'error');
    }
  }

  function getProxyUrl(url) {
    const selectedProxy = document.querySelector('input[name="proxyOption"]:checked').value;
    
    if (selectedProxy === 'direct') return url;
    
    const encodedUrl = encodeURIComponent(url);
    
    switch (selectedProxy) {
      case 'corsproxy':
        return `https://corsproxy.io/?${encodedUrl}`;
      case 'allorigins':
        return `https://api.allorigins.win/raw?url=${encodedUrl}`;
      case 'corsanywhere':
        return `https://cors-anywhere.herokuapp.com/${url}`;
      case 'thingproxy':
        return `https://thingproxy.freeboard.io/fetch/${url}`;
      case 'corscontainer':
        return `https://api.codetabs.com/v1/proxy?quest=${url}`;
      case 'crossorigin':
        return `https://crossorigin.me/${url}`;
      case 'corsbridge':
        return `http://corsbridge.com/${url}`;
      case 'custom':
        return customProxyUrl ? customProxyUrl + encodedUrl : url;
      default:
        return url;
    }
  }

  async function loadUrlPlaylist() {
    const url = playlistUrl.value.trim();
    if (!url) {
      showUrlStatus('Please enter a playlist URL', 'error');
      return;
    }

    showUrlStatus('Loading playlist...', 'warning');
    
    try {
      const proxyUrl = getProxyUrl(url);
      const response = await fetch(proxyUrl);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const content = await response.text();
      parsePlaylist(content, 'URL Playlist');
      closeUrlModalHandler();
    } catch (error) {
      console.error('Error loading URL playlist:', error);
      showUrlStatus(`Error: ${error.message}`, 'error');
    }
  }

  async function testUrl() {
    const url = playlistUrl.value.trim();
    if (!url) {
      showUrlStatus('Please enter a URL to test', 'error');
      return;
    }

    showUrlStatus('Testing URL...', 'warning');
    
    try {
      const proxyUrl = getProxyUrl(url);
      const response = await fetch(proxyUrl);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      showUrlStatus('URL is accessible!', 'success');
    } catch (error) {
      console.error('Error testing URL:', error);
      showUrlStatus(`Error: ${error.message}`, 'error');
    }
  }

  function showUrlStatus(message, type) {
    urlStatus.innerHTML = `<div class="status-${type} status-message"><i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}" aria-hidden="true"></i> ${message}</div>`;
  }

  /* ---------------------------
     Groups & Channels Rendering
  ----------------------------*/
  function renderGroups() {
    if (!currentPlaylist || currentPlaylist.length === 0) {
      groupsList.innerHTML = '<div class="empty-state"><i class="fas fa-tv" aria-hidden="true"></i><h3>No channels loaded</h3><p>Upload or load a playlist to get started</p></div>';
      channelsCount.textContent = '0 channels';
      return;
    }

    // Filter channels by category
    let filteredChannels = currentPlaylist;
    if (currentCategory === 'favorites') {
      filteredChannels = currentPlaylist.filter(ch => favorites.includes(ch.id));
    } else if (currentCategory !== 'all') {
      filteredChannels = currentPlaylist.filter(ch => 
        ch.group.toLowerCase().includes(currentCategory.toLowerCase())
      );
    }

    // Apply search filter
    const searchTerm = searchInput.value.toLowerCase().trim();
    if (searchTerm) {
      filteredChannels = filteredChannels.filter(ch => 
        ch.name.toLowerCase().includes(searchTerm)
      );
    }

    // Group channels
    const groups = {};
    filteredChannels.forEach(channel => {
      if (!groups[channel.group]) {
        groups[channel.group] = [];
      }
      groups[channel.group].push(channel);
    });

    // Render groups
    groupsList.innerHTML = '';
    
    if (Object.keys(groups).length === 0) {
      groupsList.innerHTML = '<div class="empty-state"><i class="fas fa-search" aria-hidden="true"></i><h3>No channels found</h3><p>Try changing your search or category</p></div>';
      channelsCount.textContent = '0 channels';
      return;
    }

    Object.keys(groups).forEach(groupName => {
      const groupItem = document.createElement('div');
      groupItem.className = 'group-item';
      groupItem.innerHTML = `
        <div class="group-header">
          <div class="group-name">${groupName}</div>
          <div class="group-count">${groups[groupName].length}</div>
        </div>
        <div class="channels-list"></div>
      `;

      const channelsList = groupItem.querySelector('.channels-list');
      const channels = groups[groupName];
      
      // Render first batch of channels
      renderChannelBatch(channelsList, channels, 0);
      
      // Add "Load more" if there are more channels
      if (channels.length > CHANNEL_RENDER_BATCH) {
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.className = 'btn btn-outline';
        loadMoreBtn.style.marginTop = '10px';
        loadMoreBtn.style.width = '100%';
        loadMoreBtn.textContent = `Load more (${channels.length - CHANNEL_RENDER_BATCH} remaining)`;
        loadMoreBtn.addEventListener('click', () => {
          loadMoreBtn.remove();
          renderChannelBatch(channelsList, channels, CHANNEL_RENDER_BATCH);
        });
        channelsList.appendChild(loadMoreBtn);
      }

      groupsList.appendChild(groupItem);
    });

    // Add event listeners to groups
    document.querySelectorAll('.group-item').forEach(item => {
      item.addEventListener('click', (e) => {
        if (!e.target.closest('.channel-item') && !e.target.closest('.favorite-btn')) {
          document.querySelectorAll('.group-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
        }
      });
    });

    channelsCount.textContent = `${filteredChannels.length} channels`;
  }

  function renderChannelBatch(container, channels, startIndex) {
    const endIndex = Math.min(startIndex + CHANNEL_RENDER_BATCH, channels.length);
    
    for (let i = startIndex; i < endIndex; i++) {
      const channel = channels[i];
      const channelItem = document.createElement('div');
      channelItem.className = 'channel-item';
      channelItem.dataset.channelId = channel.id;
      
      const isFavorite = favorites.includes(channel.id);
      
      channelItem.innerHTML = `
        <img src="${channel.tvg.logo || 'https://via.placeholder.com/30x30/2c3e50/ecf0f1?text=TV'}" alt="${channel.name} logo" class="channel-logo" onerror="this.src='https://via.placeholder.com/30x30/2c3e50/ecf0f1?text=TV'">
        <div class="channel-info">
          <div class="channel-name">${channel.name}</div>
          <div class="channel-resolution">${channel.group}</div>
        </div>
        <button class="favorite-btn ${isFavorite ? 'active' : ''}" aria-label="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
          <i class="fas fa-heart" aria-hidden="true"></i>
        </button>
      `;

      container.appendChild(channelItem);
    }

    // Add event listeners to channel items and favorite buttons
    container.querySelectorAll('.channel-item').forEach(item => {
      item.addEventListener('click', (e) => {
        if (!e.target.closest('.favorite-btn')) {
          playChannel(item.dataset.channelId);
        }
      });
    });

    container.querySelectorAll('.favorite-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleFavorite(btn.closest('.channel-item').dataset.channelId);
      });
    });
  }

  /* ---------------------------
     Channel Playback
  ----------------------------*/
  function playChannel(channelId) {
    const channel = currentPlaylist.find(ch => ch.id == channelId);
    if (!channel) return;

    // Update UI
    document.querySelectorAll('.channel-item').forEach(item => {
      item.classList.remove('active');
    });
    document.querySelector(`.channel-item[data-channel-id="${channelId}"]`).classList.add('active');
    
    nowPlaying.textContent = `Now playing: ${channel.name}`;

    // Stop previous HLS instance
    if (hls) {
      hls.destroy();
      hls = null;
    }

    // Play the channel
    if (Hls.isSupported()) {
      hls = new Hls({
        debug: false,
        enableWorker: false,
        lowLatencyMode: true,
        backBufferLength: 90
      });
      
      hls.loadSource(channel.url);
      hls.attachMedia(videoPlayer);
      
      hls.on(Hls.Events.MANIFEST_PARSED, function() {
        videoPlayer.play();
        updateQualitySelector();
      });
      
      hls.on(Hls.Events.ERROR, function(event, data) {
        console.error('HLS Error:', data);
        if (data.fatal) {
          switch(data.type) {
            case Hls.ErrorTypes.NETWORK_ERROR:
              showStatus('Network error loading stream', 'error');
              break;
            case Hls.ErrorTypes.MEDIA_ERROR:
              showStatus('Media error loading stream', 'error');
              break;
            default:
              showStatus('Error loading stream', 'error');
              break;
          }
        }
      });
    } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
      // Safari native HLS support
      videoPlayer.src = channel.url;
      videoPlayer.play();
    } else {
      showStatus('HLS not supported in this browser', 'error');
    }
  }

  function updateQualitySelector() {
    if (!hls) return;
    
    const levels = hls.levels;
    qualitySelector.innerHTML = '<option value="auto">Auto</option>';
    
    levels.forEach((level, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = level.height ? `${level.height}p` : `Level ${index}`;
      qualitySelector.appendChild(option);
    });
  }

  function changeQuality() {
    if (!hls) return;
    
    const quality = qualitySelector.value;
    if (quality === 'auto') {
      hls.currentLevel = -1;
    } else {
      hls.currentLevel = parseInt(quality);
    }
  }

  /* ---------------------------
     Favorites Management
  ----------------------------*/
  function toggleFavorite(channelId) {
    const index = favorites.indexOf(parseInt(channelId));
    const btn = document.querySelector(`.channel-item[data-channel-id="${channelId}"] .favorite-btn`);
    
    if (index > -1) {
      // Remove from favorites
      favorites.splice(index, 1);
      btn.classList.remove('active');
      btn.setAttribute('aria-label', 'Add to favorites');
    } else {
      // Add to favorites
      favorites.push(parseInt(channelId));
      btn.classList.add('active');
      btn.setAttribute('aria-label', 'Remove from favorites');
    }
    
    saveFavorites();
    
    // If we're in favorites category, update the view
    if (currentCategory === 'favorites') {
      renderGroups();
    }
  }

  /* ---------------------------
     Utility Functions
  ----------------------------*/
  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      videoPlayer.requestFullscreen().catch(err => {
        console.error('Error attempting to enable fullscreen:', err);
      });
    } else {
      document.exitFullscreen();
    }
  }

  function handleSearch() {
    renderGroups();
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  function showStatus(message, type) {
    globalStatus.innerHTML = `<div class="status-${type} status-message"><i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}" aria-hidden="true"></i> ${message}</div>`;
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
      globalStatus.innerHTML = '';
    }, 3000);
  }

  /* ---------------------------
     Initialize when DOM is ready
  ----------------------------*/
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();

  </script>
</body>
</html>
