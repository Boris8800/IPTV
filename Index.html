<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Birmingham Airport Flight Arrivals & Diversions</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
  h1, h2 { color: #003366; }
  #status { margin-bottom: 15px; }
  section { margin-bottom: 30px; }
  ul { list-style: none; padding: 0; }
  li { background: #fff; margin-bottom: 8px; padding: 12px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
</style>
</head>
<body>
<h1>Birmingham Airport (BHX) Flight Arrivals & Diversions</h1>

<section>
  <h2>All Planned Arrivals in the Last Hour</h2>
  <div id="allStatus">Loading data...</div>
  <ul id="allFlightsList"></ul>
</section>

<section>
  <h2>Flights Diverted to BHX</h2>
  <div id="divertedStatus">Loading data...</div>
  <ul id="divertedFlightsList"></ul>
</section>

<script>
  const EGBB_ICAO = 'EGBB';
  const corsProxy = 'https://cors-anywhere.herokuapp.com/';
  const now = Math.floor(Date.now() / 1000);
  const oneHourAgo = now - 3600;
  const apiUrl = `https://opensky-network.org/api/flights/arrival?airport=${EGBB_ICAO}&begin=${oneHourAgo}&end=${now}`;

  async function fetchFlights() {
    document.getElementById('allStatus').textContent = 'Fetching flight data...';
    document.getElementById('divertedStatus').textContent = 'Fetching flight data...';
    try {
      const response = await fetch(corsProxy + apiUrl);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const flights = await response.json();
      displayAllFlights(flights);
      displayDivertedFlights(flights);
    } catch (err) {
      document.getElementById('allStatus').textContent = 'Error fetching data. Try again later.';
      document.getElementById('divertedStatus').textContent = 'Error fetching data. Try again later.';
      console.error('Fetch error:', err);
    }
  }

  function displayAllFlights(flights) {
    const list = document.getElementById('allFlightsList');
    list.innerHTML = '';

    if (flights.length === 0) {
      document.getElementById('allStatus').textContent = 'No arrivals detected in the last hour.';
      return;
    }

    document.getElementById('allStatus').textContent = `Found ${flights.length} arrival(s) in the last hour.`;

    flights.forEach(flight => {
      const li = document.createElement('li');
      const callsign = flight.callsign || 'N/A';
      const from = flight.estDepartureAirport || 'N/A';
      const arrivalTime = new Date(flight.lastSeen * 1000).toLocaleString();

      li.innerHTML = `<strong>Flight:</strong> ${callsign}<br/>
                      <strong>From:</strong> ${from}<br/>
                      <strong>Arrival Time:</strong> ${arrivalTime}`;
      list.appendChild(li);
    });
  }

  function displayDivertedFlights(flights) {
    const list = document.getElementById('divertedFlightsList');
    list.innerHTML = '';

    const diverted = flights.filter(
      flight => flight.estArrivalAirport === EGBB_ICAO &&
                flight.estDepartureAirport !== EGBB_ICAO
    );

    if (diverted.length === 0) {
      document.getElementById('divertedStatus').textContent = 'No diversions detected in the last hour.';
      return;
    }

    document.getElementById('divertedStatus').textContent = `Found ${diverted.length} diverted flight(s) in the last hour.`;

    diverted.forEach(flight => {
      const li = document.createElement('li');
      const callsign = flight.callsign || 'N/A';
      const from = flight.estDepartureAirport || 'N/A';
      const arrivalTime = new Date(flight.lastSeen * 1000).toLocaleString();

      li.innerHTML = `<strong>Flight:</strong> ${callsign}<br/>
                      <strong>Originally From:</strong> ${from}<br/>
                      <strong>Arrival Time:</strong> ${arrivalTime}`;
      list.appendChild(li);
    });
  }

  fetchFlights();
  // Refresh every 10 minutes
  setInterval(fetchFlights, 10 * 60 * 1000);
</script>
</body>
</html>
